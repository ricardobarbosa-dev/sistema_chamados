{% extends 'base.html' %}

{% block content %}

{% if request.user.is_staff or chamado.criado_por == request.user %}

<div class="max-w-4xl mx-auto space-y-6 px-2 sm:px-0">

  <!-- CabeÃ§alho -->
  <div class="bg-gray-800 rounded-lg p-5 sm:p-6">
    <h2 class="text-xl sm:text-2xl font-bold text-white">
      {{ chamado.titulo }}
    </h2>

    <p class="text-gray-300 mt-3 text-sm sm:text-base leading-relaxed">
      {{ chamado.descricao }}
    </p>

    <!-- Exibe anexo se existir -->
    {% if chamado.anexo %}
      <p class="mt-2 text-gray-300 text-sm sm:text-base">
        <strong>Attachment:</strong>
        <a href="{{ chamado.anexo.url }}" target="_blank" class="underline text-blue-400">
          View/Download
        </a>
      </p>
    {% endif %}

    <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-3 text-sm">
      <span class="px-3 py-1 rounded-full bg-blue-600 text-white font-semibold w-fit">
        {{ chamado.get_status_display }}
      </span>

      <span class="text-gray-400">
        Criado por <b>{{ chamado.criado_por.username }}</b> â€¢
        {{ chamado.criado_em|date:'d/m/Y H:i' }}
      </span>
    </div>
  </div>

  <!-- Timeline -->
  <div class="space-y-6">
    {% for item in timeline %}
      <div class="flex gap-3 sm:gap-4" {% if forloop.last %}id="ultimo-item"{% endif %}>

        <!-- Linha -->
        <div class="flex flex-col items-center">
          <div class="w-3 h-3 rounded-full
            {% if item.tipo == 'status' %}bg-yellow-500{% endif %}
            {% if item.tipo == 'resposta' %}bg-blue-500{% endif %}
          "></div>

          {% if not forloop.last %}
            <div class="flex-1 w-px bg-gray-700"></div>
          {% endif %}
        </div>

        <!-- Card -->
        <div class="flex-1 rounded-lg p-4 shadow-md
          {% if request.user not in item.obj.lido_por.all and item.tipo == 'status' %}
            bg-yellow-900 border border-yellow-500
          {% elif request.user not in item.obj.lido_por.all and item.tipo == 'resposta' %}
            bg-blue-900 border border-blue-500
          {% else %}
            bg-gray-800
          {% endif %}
        ">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
            <span class="text-white font-semibold text-sm sm:text-base">
              {{ item.usuario.username }}

              {% if request.user not in item.obj.lido_por.all %}
                <span class="ml-2 text-xs px-2 py-0.5 rounded
                             bg-red-600 text-white font-bold animate-pulse">
                  NÃƒO LIDO
                </span>
              {% endif %}

              {% if item.usuario.is_staff %}
                <span class="ml-2 text-xs px-2 py-0.5 rounded
                             bg-purple-600 text-white">
                  Admin
                </span>
              {% endif %}
            </span>

            <span class="text-xs text-gray-400">
              {{ item.data|date:'d/m/Y H:i' }}
            </span>
          </div>

          {% if item.tipo == 'status' %}
            <p class="text-yellow-400 text-sm mt-3 font-semibold">
              Status alterado
            </p>

            <div class="mt-2 text-gray-300 flex flex-wrap items-center gap-2 text-sm">
              <span class="line-through text-red-400">
                {{ item.status_anterior }}
              </span>
              <span class="text-gray-400">â†’</span>
              <span class="text-green-400 font-bold">
                {{ item.novo_status }}
              </span>
            </div>

          {% elif item.tipo == 'resposta' %}
            <p class="text-blue-400 text-sm mt-3 font-semibold">
              Resposta
            </p>

            <p class="text-gray-300 mt-2 whitespace-pre-line leading-relaxed text-sm sm:text-base">
              {{ item.mensagem }}
            </p>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="text-center text-gray-500">
        Nenhuma atividade neste chamado.
      </p>
    {% endfor %}
  </div>

  <!-- Nova resposta -->
  <div class="bg-gray-800 rounded-lg p-5 sm:p-6">
    <h3 class="text-lg font-semibold text-white mb-4">
      Nova resposta
    </h3>

    {% if not pode_responder %}
      <div class="bg-red-900 border border-red-600 text-red-200
                  px-4 py-3 rounded text-sm font-semibold">
        ðŸ”’ This call is closed. You can no longer reply.
      </div>
    {% else %}
      <form method="post" class="space-y-4" enctype="multipart/form-data">
        {% csrf_token %}

        <textarea
          name="mensagem"
          rows="4"
          required
          class="w-full p-3 rounded-lg bg-gray-900 text-white
                 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base"
          placeholder="Digite sua resposta..."
        ></textarea>

        <label for="anexo" class="text-white font-semibold">Attachment (optional)</label>
        <input
          type="file"
          name="anexo"
          id="anexo"
          class="w-full border border-gray-600 p-2 rounded bg-gray-800 text-white"
        />

        <button
          type="submit"
          class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 px-6 py-2
                 rounded-lg text-white font-semibold transition"
        >
          Enviar resposta
        </button>
      </form>
    {% endif %}
  </div>

</div>

<!-- Scroll automÃ¡tico -->
<script>
  window.addEventListener('load', () => {
    const ultimo = document.getElementById('ultimo-item')
    if (ultimo) {
      ultimo.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      })
    }
  })
</script>

{% else %}

<div class="max-w-xl mx-auto bg-red-900 border border-red-600
            text-red-200 px-6 py-5 rounded-lg text-center font-semibold">
   You do not have permission to view this ticket.
</div>

{% endif %}

{% endblock %}
