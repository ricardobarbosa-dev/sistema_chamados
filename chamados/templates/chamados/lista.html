{% extends 'base.html' %}

{% block content %}
<div class="max-w-5xl mx-auto px-2 md:px-0">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
    <h2 class="text-2xl font-bold text-white">Tickets</h2>

    <a href="{% url 'criar_chamado' %}"
       class="bg-blue-600 text-white px-4 py-2 rounded text-center hover:bg-blue-700">
      New ticket
    </a>
  </div>

  <!-- ðŸ“± Mobile search -->
  <div class="md:hidden mb-3">
    <input id="searchMobile" type="text"
      placeholder="Search by title..."
      class="w-full bg-gray-800 text-white rounded p-2 placeholder-gray-400">
  </div>

  <!-- ðŸ“± Mobile filter -->
  <div class="md:hidden mb-5">
    <select id="statusMobile"
      class="w-full bg-gray-800 text-white rounded p-2">
      <option value="all">All statuses</option>
      <option value="aberto">Open</option>
      <option value="andamento">In progress</option>
      <option value="fechado">Closed</option>
    </select>
  </div>

  <!-- ðŸ–¥ï¸ Desktop search + filter -->
  <div class="hidden md:flex gap-4 mb-4">
    <input id="searchDesktop" type="text"
      placeholder="Search by title..."
      class="flex-1 bg-gray-800 text-white rounded p-2 placeholder-gray-400">

    <select id="statusDesktop"
      class="bg-gray-800 text-white rounded p-2">
      <option value="all">All statuses</option>
      <option value="aberto">Open</option>
      <option value="andamento">In progress</option>
      <option value="fechado">Closed</option>
    </select>
  </div>

  <!-- ðŸ–¥ï¸ Desktop table -->
  <div class="hidden md:block bg-gray-800 rounded overflow-hidden">
    <table class="w-full table-auto">
      <thead class="bg-gray-700 text-gray-100">
        <tr>
          <th class="px-4 py-3 text-left">Title</th>
          <th class="px-4 py-3 text-left">Status</th>

          {% if user.is_superuser %}
            <th class="px-4 py-3 text-left">Change status</th>
            <th class="px-4 py-3 text-left">Username</th>
          {% endif %}

          <th class="px-4 py-3 text-left">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for item in chamados_com_nao_lido %}
        <tr class="border-t border-gray-700 chamado-row"
            data-title="{{ item.chamado.titulo|lower }}"
            data-status="{{ item.chamado.status }}">

          <td class="p-3">
            <a href="{% url 'detalhe_chamado' item.chamado.id %}"
               class="text-white hover:underline font-medium">
              {{ item.chamado.titulo }}
            </a>

            {% if item.nao_lido %}
              <span class="ml-1 text-xs font-semibold text-red-500 animate-pulse">
                New
              </span>
            {% endif %}
          </td>

          <td class="p-3">
            <span class="px-2 py-1 rounded text-sm font-semibold
              {% if item.chamado.status == 'aberto' %}bg-green-100 text-green-700{% endif %}
              {% if item.chamado.status == 'andamento' %}bg-yellow-100 text-yellow-700{% endif %}
              {% if item.chamado.status == 'fechado' %}bg-red-100 text-red-700{% endif %}
            ">
              {{ item.chamado.get_status_display }}
            </span>
          </td>

          {% if user.is_superuser %}
          <td class="p-3">
            <form method="post" action="{% url 'alterar_status_chamado' item.chamado.id %}">
              {% csrf_token %}
              <select name="status"
                class="border rounded px-2 py-1 text-sm"
                onchange="this.form.submit()">
                {% for value, label in item.chamado.STATUS_CHOICES %}
                  <option value="{{ value }}" {% if item.chamado.status == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </td>

          <td class="p-3 text-white">
            {{ item.chamado.criado_por.username }}
          </td>
          {% endif %}

          <td class="p-3 flex gap-4">
            {% if user.is_superuser or item.chamado.criado_por == user and item.chamado.status != 'fechado' %}
              <a href="{% url 'editar_chamado' item.chamado.id %}" class="text-blue-500">
                Edit
              </a>
            {% endif %}

            {% if user.is_superuser %}
              <a href="{% url 'excluir_chamado' item.chamado.id %}"
                 class="text-red-500"
                 onclick="return confirm('Are you sure?')">
                Delete
              </a>
            {% endif %}
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ðŸ“± Mobile cards -->
  <div class="md:hidden space-y-4">
    {% for item in chamados_com_nao_lido %}
    <div class="bg-gray-800 rounded-lg p-4 space-y-3 chamado-card"
         data-title="{{ item.chamado.titulo|lower }}"
         data-status="{{ item.chamado.status }}">

      <div class="flex justify-between">
        <a href="{% url 'detalhe_chamado' item.chamado.id %}"
           class="text-white font-semibold text-lg">
          {{ item.chamado.titulo }}
        </a>

        {% if item.nao_lido %}
          <span class="text-xs bg-red-600 text-white px-2 rounded-full animate-pulse">
            New
          </span>
        {% endif %}
      </div>

      <span class="px-2 py-0.5 rounded-full text-xs font-semibold text-white
        {% if item.chamado.status == 'aberto' %}bg-green-600{% endif %}
        {% if item.chamado.status == 'andamento' %}bg-yellow-500{% endif %}
        {% if item.chamado.status == 'fechado' %}bg-red-600{% endif %}
      ">
        {{ item.chamado.get_status_display }}
      </span>
    </div>
    {% endfor %}
  </div>

</div>

<!-- ðŸ” Unified filter script -->
<script>
  function filterItems(search, status, elements) {
    elements.forEach(el => {
      const title = el.dataset.title
      const st = el.dataset.status

      const okTitle = title.includes(search)
      const okStatus = status === 'all' || st === status

      el.classList.toggle('hidden', !(okTitle && okStatus))
    })
  }

  const searchDesktop = document.getElementById('searchDesktop')
  const statusDesktop = document.getElementById('statusDesktop')
  const rows = document.querySelectorAll('.chamado-row')

  const searchMobile = document.getElementById('searchMobile')
  const statusMobile = document.getElementById('statusMobile')
  const cards = document.querySelectorAll('.chamado-card')

  searchDesktop?.addEventListener('input', () =>
    filterItems(searchDesktop.value.toLowerCase(), statusDesktop.value, rows)
  )
  statusDesktop?.addEventListener('change', () =>
    filterItems(searchDesktop.value.toLowerCase(), statusDesktop.value, rows)
  )

  searchMobile?.addEventListener('input', () =>
    filterItems(searchMobile.value.toLowerCase(), statusMobile.value, cards)
  )
  statusMobile?.addEventListener('change', () =>
    filterItems(searchMobile.value.toLowerCase(), statusMobile.value, cards)
  )
</script>

{% endblock %}
